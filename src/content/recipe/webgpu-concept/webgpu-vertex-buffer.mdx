---
title: é ‚ç‚¹ãƒãƒƒãƒ•ã‚¡ã¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
date: "2025-04-22"
description: CPUã‹ã‚‰GPUã¸ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™åŸºæœ¬ã®ä»•çµ„ã¿
series: webgpu-concept
references:
  - title: ã‚ã‚‰ãŸã‚ã¦ç†è§£ã™ã‚‹ArrayBuffer - JavaScriptã§ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã†æ–¹æ³•
    url: https://ics.media/entry/250408/
  - title: WebGPU Vertex Buffers
    url: https://webgpufundamentals.org/webgpu/lessons/webgpu-vertex-buffers.html
  - title: WebGPU Buffer Uploads - Best practices
    url: https://toji.dev/webgpu-best-practices/buffer-uploads
  - title: WebGPU Copying Data
    url: https://webgpufundamentals.org/webgpu/lessons/webgpu-copying-data.html
  - title: WebGPU Bind Group Layouts
    url: https://webgpufundamentals.org/webgpu/lessons/webgpu-bind-group-layouts.html
tags:
  - webgpu
  - wgsl
draft: true
---

> [!note]
>
> - https://chatgpt.com/c/6806e75b-a60c-8000-a5e8-66fb838d8749
> - https://chatgpt.com/c/6807595b-4fe4-8000-bf42-24caa3c7069b

import DemoLinkWithResult from "$/components/demo/DemoLinkWithResult.astro"

import img_WebGPUTriangleVertexBuffer from "../../../assets/recipes/webgpu-concept/webgpu-triangle-vertex-buffer.png"

:SeriesPrevLink[å‰å›]{series="webgpu-concept" current="webgpu-vertex-buffer"}ã¯ã€WebGPUã‚’ä½¿ã£ã¦ä¸‰è§’å½¢ã‚’æç”»ã™ã‚‹å‡¦ç†ã‚’å®Œæˆã•ã›ã¾ã—ãŸã€‚

ã¨ã“ã‚ã§ã€ä¸‰è§’å½¢ã®é ‚ç‚¹ã®åº§æ¨™ã¯é ‚ç‚¹ã‚·ã‚§ãƒ¼ãƒ€å†…ã§é…åˆ—ã¨ã—ã¦å®šç¾©ã—ã¦ã„ã¾ã—ãŸãŒã€é€šå¸¸ã¯ã“ã®ã‚ˆã†ãªã“ã¨ã¯ã—ã¾ã›ã‚“ã€‚
ãªãœãªã‚‰ã€é ‚ç‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ã‚§ãƒ¼ãƒ€å†…ã§å®šç¾©ã—ã¦ã—ã¾ã†ã¨ã€ãã®ã‚·ã‚§ãƒ¼ãƒ€ã¯ãã®å›³å½¢å°‚ç”¨ã®ã‚·ã‚§ãƒ¼ãƒ€ã«ãªã£ã¦ã—ã¾ã†ã‹ã‚‰ã§ã™ã€‚

ã‚·ã‚§ãƒ¼ãƒ€ã¯ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«çµ„ã¿è¾¼ã‚€ã“ã¨ã§ã€åˆã‚ã¦åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
WebGPUã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ä½œæˆã¯ãã‚Œãªã‚Šã«é‡ã„å‡¦ç†ã§ã‚ã‚Šã€å›³å½¢ã”ã¨ã«ã‚·ã‚§ãƒ¼ãƒ€ã¨ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ç”¨æ„ã—ã¦åˆ‡ã‚Šæ›¿ãˆãªãŒã‚‰æç”»ã™ã‚‹ã®ã¯éåŠ¹ç‡ã§ã™ã€‚

ãã“ã§ã€GPUã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™ãŸã‚ã®ä»•çµ„ã¿ã¨ã—ã¦ã€==ãƒãƒƒãƒ•ã‚¡==ã‚’å°å…¥ã—ã¾ã™ã€‚

## ãƒãƒƒãƒ•ã‚¡ã‚’ä»‹ã—ãŸãƒ‡ãƒ¼ã‚¿ã®ã‚„ã‚Šå–ã‚Š

==ãƒãƒƒãƒ•ã‚¡==ã¨ã¯ã€GPUã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ¡ãƒ¢ãƒªä¸Šã®ãƒ‡ãƒ¼ã‚¿åˆ—ã‚’è¡¨ã™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚ã€ç°¡å˜ã«è¨€ãˆã°**GPUã«æ¸¡ã™ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œã¦ãŠãç®±ã®ã‚ˆã†ãªã‚‚ã®**ã§ã™ã€‚ã‚‚ã†å°‘ã—æ­£ç¢ºã«è¨€ã†ã¨ã€**GPUãŒä½¿ã†ãŸã‚ã®ãƒ¡ãƒ¢ãƒªé ˜åŸŸ**ã‚’æ„å‘³ã—ã¾ã™ã€‚

é ‚ç‚¹ã®åº§æ¨™ã‚„è‰²ãªã©ã®æƒ…å ±ã¯ã€æ™®é€šã¯ã‚·ã‚§ãƒ¼ãƒ€ã¨ã¯åˆ¥ã«ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ç”¨æ„ã—ã¦ã€ã‚·ã‚§ãƒ¼ãƒ€ã«æ¸¡ã—ã¾ã™ã€‚

ã—ã‹ã—ã€ã‚·ã‚§ãƒ¼ãƒ€ã¯æ™®é€šã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¨é•ã„ã€CPUä¸Šã§ã¯ãªãGPUä¸Šã§å‹•ããƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã™ã€‚ãã®ãŸã‚ã€æ™®é€šã®ãƒ¡ãƒ¢ãƒªä¸Šã«ã‚ã‚‹å¤‰æ•°ã®å€¤ãªã©ã¯åŸºæœ¬çš„ã«èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚
ã‚·ã‚§ãƒ¼ãƒ€ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™ãŸã‚ã«ã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚’==GPUã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ¡ãƒ¢ãƒª==ã«ç½®ã„ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

GPUã‹ã‚‰æ™®é€šã®ãƒ¡ãƒ¢ãƒªã®å†…å®¹ã¯å‚ç…§ã§ããªã„ãŸã‚ã€ã‚·ã‚§ãƒ¼ãƒ€ã§ä½¿ã„ãŸã„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã€ã¾ãšGPUã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒ¡ãƒ¢ãƒªã«ç§»ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã—ã¦ãã‚Œã¯ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ä¸Šã§ã¯ã€Œãƒãƒƒãƒ•ã‚¡ã«æ›¸ãè¾¼ã‚€ã€ã€Œãƒãƒƒãƒ•ã‚¡ã«æ›¸ãè¾¼ã‚“ã§è»¢é€ã™ã‚‹ã€ã¨ã„ã†å½¢ã«ãªã‚Šã¾ã™ã€‚

==ãƒãƒƒãƒ•ã‚¡==ã¯CPUã‹ã‚‰GPUã¸ã®=p=å—ã‘æ¸¡ã—å ´æ‰€==ã¨ã‚‚ã„ãˆã¾ã™ã€‚

### WebGPUãŒæ‰±ã†ãƒ¡ãƒ¢ãƒª

WebGPUã¯å¤§ããåˆ†ã‘ã¦ã€2ç¨®é¡ã®ãƒ¡ãƒ¢ãƒªã‚’æ‰±ã£ã¦ã„ã‚‹ã¨è€ƒãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

- ==GPUã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½==ãªãƒ¡ãƒ¢ãƒª
- ==CPUã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½==ã§ã€GPUã«åŠ¹ç‡ã‚ˆãã‚³ãƒ”ãƒ¼ã§ãã‚‹ãƒ¡ãƒ¢ãƒª

ã‚·ã‚§ãƒ¼ãƒ€ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„ã¨ãã¯ã€ãã®ãƒ‡ãƒ¼ã‚¿ã¯==GPUã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒ¡ãƒ¢ãƒª==ã«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ä¸€æ–¹ã€JavaScriptã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„å ´åˆã¯ã€ãã®ãƒ‡ãƒ¼ã‚¿ã¯==CPUã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒ¡ãƒ¢ãƒª==ã«å­˜åœ¨ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### è£œè¶³ï¼šäº’æ›æ€§ã¨ã„ã†ã€ŒWebã‚‰ã—ã•ã€

ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ãªã©ä¸€éƒ¨ã®ãƒ‡ãƒã‚¤ã‚¹ã§ã¯ã€GPUã¨CPUãŒåŒã˜ãƒ¡ãƒ¢ãƒªã‚’å…±æœ‰ã—ã¦ã„ã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚
ã—ã‹ã—ã€WebGPUã¯Webä¸Šã§å‹•ãAPIãªã®ã§ã€=p=ãªã‚‹ã¹ãå¤šãã®ç¨®é¡ã®ãƒ‡ãƒã‚¤ã‚¹ã§åŒã˜ã‚³ãƒ¼ãƒ‰ãŒå‹•ä½œã™ã‚‹==ã“ã¨ã‚’é‡è¦–ã—ã¾ã™ã€‚
ãã®ãŸã‚ã€WebGPUã¯ã™ã¹ã¦ã®ç’°å¢ƒãŒã€ŒGPUã¨CPUãŒåˆ¥ã€…ã®ãƒ¡ãƒ¢ãƒªã‚’æŒã£ã¦ã„ã‚‹ã€ã¨ä»®å®šã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã‹ã›ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚ã‚ã¨ã¯ã€WebGPUå†…éƒ¨ã§ç’°å¢ƒã«å¿œã˜ã¦æœ€é©åŒ–ã‚’ã—ã¦ãã‚Œã‚‹ã‚ã‘ã§ã™ã€‚

## ä¸‰è§’å½¢ã®ãŸã‚ã®é ‚ç‚¹ãƒãƒƒãƒ•ã‚¡ã‚’ä½œã‚‹

### JavaScriptå´ã§é ‚ç‚¹åº§æ¨™ã‚’å®šç¾©

å‰å›å®Ÿè£…ã—ãŸä¸‰è§’å½¢ã‚’æç”»ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã§ã¯ã€é ‚ç‚¹ã‚·ã‚§ãƒ¼ãƒ€å†…ã§å®šç¾©ã—ãŸ`pos{:wgsl}`ã¨ã„ã†é…åˆ—ã«ã€3ã¤ã®é ‚ç‚¹ã®åº§æ¨™ã‚’å®šç¾©ã—ã¦ã„ã¾ã—ãŸã€‚

```wgsl title="ğŸ”™ WGSLã«ã‚ˆã‚‹ã‚·ã‚§ãƒ¼ãƒ€ã®ã‚³ãƒ¼ãƒ‰" showLineNumbers{9} {3-7}
@vertex
fn vs_main(in: VertexInput) -> VertexOutput {
  var pos = array<vec2f, 3>(
    vec2f( 0.0,  0.5),
    vec2f(-0.5, -0.5),
    vec2f( 0.5, -0.5)
  );

  var out: VertexOutput;
  out.Position = vec4f(pos[in.VertexIndex], 0.0, 1.0);
  return out;
}
```

ã“ã®é ‚ç‚¹ã®åº§æ¨™ï¼ˆ`pos{:wgsl}`ã®ä¸­èº«ï¼‰ã‚’ã€JavaScriptå´ã§å®šç¾©ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚

æ„šç›´ã«å†™ã—æ›¸ãã™ã‚‹ã ã‘ãªã‚‰ã€æ¬¡ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ãŒæ€ã„æµ®ã‹ã¶ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚1ã¤ã®é ‚ç‚¹ã®åº§æ¨™ã‚’1ã¤ã®é…åˆ—ã¨ã—ã€ãã‚Œã‚’3ã¤ä¸¦ã¹ãŸã€Œé…åˆ—ã®é…åˆ—ã€ã§ã™ã€‚

```js title="âŒ JSã«ã‚ˆã‚‹é ‚ç‚¹åº§æ¨™ã®å®šç¾©"
const vertices = [
  [0.0, 0.5],
  [-0.5, -0.5],
  [0.5, -0.5]
]
```

1ã¤ã®é ‚ç‚¹ã”ã¨ã®åº§æ¨™ã‚’ãã‚Œãã‚Œé…åˆ—ã§ã¾ã¨ã‚ãŸã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã€äººé–“ã«ã¨ã£ã¦ã¯ã‚ã‹ã‚Šã‚„ã™ã„ã‚‚ã®ã§ã™ã€‚
ã—ã‹ã—ã€GPUã«ãƒãƒƒãƒ•ã‚¡ã¨ã—ã¦æ¸¡ã™ã¨ãã¯ã€æ¬¡ã®ã‚ˆã†ã«ãƒ•ãƒ©ãƒƒãƒˆï¼ˆflatï¼‰ãª1æ¬¡å…ƒé…åˆ—ã§å®šç¾©ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚GPUã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ¡ãƒ¢ãƒªä¸Šã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¸¦ã¹ã‚‹ä¸Šã§ã€ãã®ã»ã†ãŒéƒ½åˆãŒã‚ˆã„ã®ã§ã™ã€‚

```js title="âŒ JSã«ã‚ˆã‚‹é ‚ç‚¹åº§æ¨™ã®å®šç¾©"
const vertices = [0.0, 0.5, -0.5, -0.5, 0.5, -0.5]
```

ã—ã‹ã—ã€ã“ã‚Œã§ã‚‚ã¾ã GPUï¼ˆã‚·ã‚§ãƒ¼ãƒ€ï¼‰ã«æ¸¡ã™ã«ã¯ä¸ååˆ†ã§ã™ã€‚
ã‚·ã‚§ãƒ¼ãƒ€ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™ã¨ãã¯ã€ã‚·ã‚§ãƒ¼ãƒ€å´ã¨å„æ•°å€¤ã®å‹ã‚’åˆã‚ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

WGSLã«ã‚ˆã‚‹é ‚ç‚¹ã‚·ã‚§ãƒ¼ãƒ€ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€æœ€çµ‚çš„ã«å‡ºåŠ›ã™ã‚‹åº§æ¨™`@builtin(position){:wgsl}`ã¯`vec4f{:wgsl}`å‹ã¨æŒ‡å®šã•ã‚Œã¦ã„ã¾ã™ã€‚

```wgsl title="ğŸ”™ WGSLã«ã‚ˆã‚‹ã‚·ã‚§ãƒ¼ãƒ€ã®ã‚³ãƒ¼ãƒ‰" showLineNumbers {2}
struct VertexOutput {
  @builtin(position) Position: vec4f
};
```

`vec4f{:wgsl}`ã¯`vec4<f32>{:wgsl}`ã®çœç•¥å½¢ã§ã‚ã‚Šã€ã¤ã¾ã‚Šåº§æ¨™ã‚’è¡¨ã™å„æ•°å€¤ã¯32ãƒ“ãƒƒãƒˆæµ®å‹•å°æ•°ç‚¹æ•°ï¼ˆ`f32{:wgsl}`å‹ï¼‰ã§ã‚ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¦ã„ã¾ã™ã€‚

ã‚·ã‚§ãƒ¼ãƒ€ã«åº§æ¨™ãƒ‡ãƒ¼ã‚¿ã‚’æ­£ã—ãåŠ¹ç‡çš„ã«æ¸¡ã™ã«ã¯ã€JavaScriptå´ã§ã‚‚ã€åº§æ¨™ã‚’è¡¨ã™å„æ•°å€¤ãŒ32ãƒ“ãƒƒãƒˆæµ®å‹•å°æ•°ç‚¹æ•°ã§ã‚ã‚‹ã“ã¨ã‚’æ˜ç¤ºã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã™ã€‚
ãã®ãŸã‚ã«ã¯ã€é€šå¸¸ã®é…åˆ—ã§ã¯ãªãã€`Float32Array{:js}`ã¨ã„ã†å‹ä»˜ãã®é…åˆ—ã‚’ä½¿ã„ã¾ã™ã€‚

```js title="âœ… JSã«ã‚ˆã‚‹é ‚ç‚¹åº§æ¨™ã®å®šç¾©"
const vertices = new Float32Array([0.0, 0.5, -0.5, -0.5, 0.5, -0.5])
```

### é ‚ç‚¹åº§æ¨™ã®ãŸã‚ã®ãƒãƒƒãƒ•ã‚¡ã‚’ä½œæˆ

ã“ã®`vertices{:js}`é…åˆ—ã‚’GPUã«æ¸¡ã™ãŸã‚ã«ã¯ã€ãƒãƒƒãƒ•ã‚¡ã‚’ä½œæˆã—ã¦ã€ãã“ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã‚“ã§ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```js title="JavaScriptã®ã‚³ãƒ¼ãƒ‰"
const vertexBuffer = device.createBuffer({
  size: vertices.byteLength,
  usage: GPUBufferUsage.VERTEX | GPUBufferUsage.COPY_DST,
  mappedAtCreation: true
})
new Float32Array(vertexBuffer.getMappedRange()).set(vertices)
vertexBuffer.unmap()
```

## è£œè¶³ï¼šãƒãƒƒãƒ•ã‚¡ã¸ã®æ›¸ãè¾¼ã¿æ‰‹æ³•

## ç™ºå±•ï¼šãƒ‡ãƒ¼ã‚¿ã®èª­ã¿æ›¸ãã®è£å´

ã“ã‚Œã‚‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ä¸€éƒ¨ã¯ã€WebGPU ã®ä¾¿åˆ©ãƒ¡ã‚½ãƒƒãƒ‰ãŒ**è£ã§è‡ªå‹•çš„ã«ã‚„ã£ã¦ãã‚Œã‚‹**å ´åˆã‚‚ã‚ã‚Šã¾ã™ã€‚  
ã§ã‚‚ã€ã»ã¨ã‚“ã©ã®ã‚±ãƒ¼ã‚¹ã§ã¯ã“ã®æµã‚ŒãŒåŸºæœ¬ã«ãªã£ã¦ã„ã‚‹ã¨è€ƒãˆã¦OKã§ã™ã€‚

### ãƒ‡ãƒ¼ã‚¿ã‚’GPUç”¨ã®ãƒ¡ãƒ¢ãƒªã«é€ã‚‹æµã‚Œ

GPUç”¨ã®ãƒ¡ãƒ¢ãƒªã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªä¸€é€£ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒä½¿ã‚ã‚Œã¾ã™ï¼š

1. **ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒãƒƒãƒ•ã‚¡**ï¼ˆCPU ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒãƒƒãƒ•ã‚¡ï¼‰ã‚’ä½œã‚‹  
   ä½¿ç”¨ç›®çš„ã¯ `GPUBufferUsage.MAP_WRITE | GPUBufferUsage.COPY_SRC`
2. `mapAsync()` ã‚’ä½¿ã£ã¦æ›¸ãè¾¼ã¿ç”¨ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹ï¼ˆJavaScript ã® `ArrayBuffer` ã¨ã—ã¦æ‰±ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ï¼‰
3. ãƒ‡ãƒ¼ã‚¿ã‚’ `ArrayBuffer` ã«æ›¸ãè¾¼ã‚€
4. ãƒãƒƒãƒ•ã‚¡ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’è§£é™¤ã™ã‚‹ï¼ˆunmapï¼‰
5. `copyBufferToBuffer()` ã¾ãŸã¯ `copyBufferToTexture()` ã‚’ä½¿ã£ã¦ã€GPU ç”¨ã®ãƒ¡ãƒ¢ãƒªã«ã‚³ãƒ”ãƒ¼ã™ã‚‹

### GPUç”¨ã®ãƒ¡ãƒ¢ãƒªã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å‡ºã™æµã‚Œ

é€†ã«ã€GPU ã®ãƒ¡ãƒ¢ãƒªã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã‚€ã¨ãã‚‚ä¼¼ãŸã‚ˆã†ãªæµã‚Œã«ãªã‚Šã¾ã™ï¼š

1. **ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒãƒƒãƒ•ã‚¡**ï¼ˆCPU èª­ã¿å‡ºã—ç”¨ï¼‰ã‚’ä½œã‚‹  
   ä½¿ç”¨ç›®çš„ã¯ `GPUBufferUsage.MAP_READ | GPUBufferUsage.COPY_DST`
2. `copyBufferToBuffer()` ã‚„ `copyTextureToBuffer()` ã§ GPU ãƒ¡ãƒ¢ãƒªã‹ã‚‰ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒãƒƒãƒ•ã‚¡ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹
3. `mapAsync()` ã‚’ä½¿ã£ã¦èª­ã¿å‡ºã—ç”¨ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹ï¼ˆJavaScript ã® `ArrayBuffer` ã¨ã—ã¦èª­ã‚ã‚‹ã‚ˆã†ã«ãªã‚‹ï¼‰
4. ãƒ‡ãƒ¼ã‚¿ã‚’ `ArrayBuffer` ã‹ã‚‰èª­ã¿å‡ºã™
5. ãƒãƒƒãƒ•ã‚¡ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’è§£é™¤ã™ã‚‹

## ãƒãƒƒãƒ•ã‚¡ã®ä¸­èº«ã¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

ãƒãƒƒãƒ•ã‚¡ã®ä¸­èº«ã¯ã€**ãŸã ã®é€£ç¶šã—ãŸãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿**ã§ã™ã€‚ãŸã¨ãˆã°ã€`[0.0, 1.0, 0.0, 1.0]` ã®ã‚ˆã†ãªæµ®å‹•å°æ•°ç‚¹æ•°ï¼ˆ`Float32`ï¼‰ãŒãšã‚‰ã£ã¨ä¸¦ã‚“ã§ã„ãŸã‚Šã€`[1, 2, 3, 4]` ã®ã‚ˆã†ãªæ•´æ•°åˆ—ã ã£ãŸã‚Šã—ã¾ã™ã€‚

ã§ã‚‚GPUã¯ãã‚Œã‚’ã€Œè‰²ã€ã‚„ã€Œåº§æ¨™ã€ã¨ã—ã¦ç›´æ¥ç†è§£ã—ã¦ãã‚Œã‚‹ã‚ã‘ã§ã¯ãªã„ã®ã§ã€**ã€Œã“ã®ãƒãƒƒãƒ•ã‚¡ã®ã“ã®å ´æ‰€ã«ã¯ã€ä½•ã®ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ã¦ã„ã‚‹ã®ã‹ã€ã‚’ä¸€ç·’ã«ä¼ãˆã‚‹å¿…è¦**ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã‚ŒãŒã€Œãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆlayoutï¼‰ã€ã§ã™ã€‚ãŸã¨ãˆã°ã€Œ1ã¤ã®é ‚ç‚¹ã«ã¯ã€ä½ç½®ãŒ3ã¤ï¼ˆX, Y, Zï¼‰ã€è‰²ãŒ4ã¤ï¼ˆR, G, B, Aï¼‰ã‚ã‚Šã¾ã™ã€ã¨ã„ã†ã‚ˆã†ãªæƒ…å ±ã‚’ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ å´ã§æ•™ãˆã¦ã‚ã’ã‚‹ã“ã¨ã§ã€GPUã¯ãƒãƒƒãƒ•ã‚¡ã®ä¸­èº«ã‚’æ­£ã—ãè§£é‡ˆã§ãã¾ã™ã€‚

- ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«ã¤ã„ã¦ã‚‚è§¦ã‚Œã‚‹ï¼ˆ`auto`ã§ã¯ãªã„æ›¸ãæ–¹ï¼‰

---

## [DRAFT]

ãƒãƒƒãƒ•ã‚¡ï¼ˆ`GPUBuffer`ï¼‰ã¯ **GPUç”¨** ã‹ **CPUç”¨** ã®ã©ã¡ã‚‰ã‹ã«å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€**ä¸¡æ–¹ã«ã¯ã§ãã¾ã›ã‚“**ã€‚  
ä¸€æ–¹ã€ãƒ†ã‚¯ã‚¹ãƒãƒ£ï¼ˆ`GPUTexture`ï¼‰ã¯ **å¸¸ã« GPU ã‚¢ã‚¯ã‚»ã‚¹å°‚ç”¨** ã§ã™ã€‚

---

## ãªãœæ˜ç¤ºçš„ãªç®¡ç†ãŒå¿…è¦ãªã®ã‹ï¼Ÿ

WebGLã§ã¯ã€ãƒãƒƒãƒ•ã‚¡ã‚’ä½œã‚‹ã¨ãã‚„ä½¿ã†ã¨ãã«ã‚ã¾ã‚Šå¤šãã®æƒ…å ±ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`gl.createBuffer()`ã§ä½œã‚Šã€`gl.bufferData()`ã§æ›¸ãè¾¼ã‚€ã ã‘ã§ã™ã€‚ãŸã ã—ãã®è£ã§ã¯ã€å¤šãã®çŠ¶æ…‹ã‚„æŒ™å‹•ãŒæš—é»™çš„ã«å‡¦ç†ã•ã‚Œã¦ãŠã‚Šã€ã€Œãªãœã“ã®æç”»ãŒå¤±æ•—ã—ãŸã®ã‹ã€ãŒã‚ã‹ã‚Šã¥ã‚‰ã„ã“ã¨ã‚‚ã‚ˆãã‚ã‚Šã¾ã—ãŸã€‚

WebGPUã§ã¯é€†ã«ã€**ãƒãƒƒãƒ•ã‚¡ã‚’ä½œæˆã™ã‚‹æ™‚ç‚¹ã§ç´°ã‹ã„æŒ‡å®šãŒå¿…è¦**ã«ãªã‚Šã¾ã™ã€‚ãã®åˆ†ã€é–‹ç™ºè€…ãŒæ„å›³ã‚’ã¯ã£ãã‚Šä¼ãˆã‚‹ã“ã¨ãŒã§ãã€GPUå´ã§ã‚‚æœ€é©ãªãƒªã‚½ãƒ¼ã‚¹ã®æº–å‚™ãŒã—ã‚„ã™ããªã‚Šã¾ã™ã€‚ã“ã‚Œã¯ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚„ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã®é¢ã§ã‚‚é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

## ãƒãƒƒãƒ•ã‚¡ã®ä½œæˆã¨ç”¨é€”æŒ‡å®š

WebGPUã§ãƒãƒƒãƒ•ã‚¡ã‚’ä½œã‚‹ã«ã¯ã€`device.createBuffer()` ã¨ã„ã†é–¢æ•°ã‚’ä½¿ã„ã¾ã™ã€‚ã“ã®ã¨ãã€ã©ã®ã‚ˆã†ãªä½¿ã„æ–¹ã‚’ã™ã‚‹ã‹ã‚’ `usage` ã¨ã„ã†ãƒ•ãƒ©ã‚°ã§æ˜ç¤ºã—ã¾ã™ã€‚ãŸã¨ãˆã°ï¼š

- **`VERTEX`**ï¼šé ‚ç‚¹ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä½¿ã†
- **`COPY_SRC` / `COPY_DST`**ï¼šä»–ã®ãƒãƒƒãƒ•ã‚¡ã‚„ãƒ†ã‚¯ã‚¹ãƒãƒ£ã¨ã®é–“ã§ã‚³ãƒ”ãƒ¼ã™ã‚‹ãŸã‚ã«ä½¿ã†

ã“ã®ã‚ˆã†ã«ã€**ã©ã†ä½¿ã†ã‹ã‚’æœ€åˆã‹ã‚‰æ˜ç¤ºã™ã‚‹**ã®ãŒWebGPUã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ã§ã™ã€‚

## ãƒãƒƒãƒ•ã‚¡ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™æ–¹æ³•

WebGPUã§ã¯ã€ãƒãƒƒãƒ•ã‚¡ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™æ–¹æ³•ã‚‚æ˜ç¤ºçš„ã§ã™ã€‚ã‚ˆãä½¿ã‚ã‚Œã‚‹ã®ãŒã€`mappedAtCreation: true` ã‚’æŒ‡å®šã—ã¦ä½œæˆæ™‚ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã€JavaScriptå´ã‹ã‚‰ãƒãƒƒãƒ•ã‚¡ã®ãƒ¡ãƒ¢ãƒªã«ç›´æ¥æ›¸ãè¾¼ã‚€æ–¹æ³•ã§ã™ã€‚

```javascript
const buffer = device.createBuffer({
  size: 256,
  usage: GPUBufferUsage.UNIFORM | GPUBufferUsage.COPY_DST,
  mappedAtCreation: true
})

const arrayBuffer = buffer.getMappedRange()
new Float32Array(arrayBuffer).set([1.0, 0.0, 0.0, 1.0])
buffer.unmap()
```

ã“ã“ã§ `getMappedRange()` ã«ã‚ˆã£ã¦å¾—ã‚‰ã‚Œã‚‹ã®ã¯ã€ç”Ÿã®ãƒ¡ãƒ¢ãƒªé ˜åŸŸã§ã™ã€‚ãã“ã« `Float32Array` ãªã©ã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã¿ã€`unmap()` ã‚’å‘¼ã¶ã“ã¨ã§ã€GPUå´ã§åˆ©ç”¨å¯èƒ½ãªçŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚

ãªãŠã€ãƒãƒƒãƒ•ã‚¡ã‚’ä½¿ã„å›ã—ã¦å†…å®¹ã ã‘æ›¸ãæ›ãˆã‚‹ã‚ˆã†ãªå ´åˆã«ã¯ã€éãƒãƒƒãƒ—æ–¹å¼ã§ `queue.writeBuffer()` ã‚’ä½¿ã†æ–¹æ³•ã‚‚ã‚ã‚Šã¾ã™ã€‚

## ãƒãƒƒãƒ•ã‚¡ã®ç ´æ£„ã¨ãƒ¡ãƒ¢ãƒªç®¡ç†

WebGPUã®è¨­è¨ˆã§ã¯ã€ãƒªã‚½ãƒ¼ã‚¹ã¯**è‡ªå‹•ã§ç ´æ£„ã•ã‚Œã‚‹ã“ã¨ã‚’å‰æã¨ã—ã¾ã›ã‚“**ã€‚ä½¿ã„çµ‚ã‚ã£ãŸãƒãƒƒãƒ•ã‚¡ã¯æ˜ç¤ºçš„ã« `buffer.destroy()` ã‚’å‘¼ã‚“ã§ç ´æ£„ã™ã‚‹ã®ãŒæœ›ã¾ã—ã„ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ä¸è¦ã«ãªã£ãŸGPUãƒ¡ãƒ¢ãƒªã‚’ç¢ºå®Ÿã«è§£æ”¾ã§ãã€ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã®ãƒªã‚¹ã‚¯ã‚’æ¸›ã‚‰ã›ã¾ã™ã€‚

---

## å®Ÿè£…ï¼šé ‚ç‚¹ãƒãƒƒãƒ•ã‚¡ã‚’ä½¿ã£ãŸä¸‰è§’å½¢ã®æç”»

```wgsl title="WGSLã«ã‚ˆã‚‹ã‚·ã‚§ãƒ¼ãƒ€ã®ã‚³ãƒ¼ãƒ‰" showLineNumbers {2,12}
struct VertexInput {
  @location(0) position: vec2f
};

struct VertexOutput {
  @builtin(position) Position: vec4f
};

@vertex
fn vs_main(in: VertexInput) -> VertexOutput {
  var out: VertexOutput;
  out.Position = vec4f(in.position, 0.0, 1.0);
  return out;
}

@fragment
fn fs_main() -> @location(0) vec4f {
  return vec4f(0.918, 0.561, 0.918, 1.0);
}
```

```js title="JavaScriptã«ã‚ˆã‚‹WebGPUã®ã‚³ãƒ¼ãƒ‰" showLineNumbers {10-17,26-37,63}
const adapter = await navigator.gpu.requestAdapter()
const device = await adapter.requestDevice()

const canvas = document.querySelector("canvas")
const context = canvas!.getContext("webgpu")

const canvasFormat = navigator.gpu.getPreferredCanvasFormat()
context.configure({ device, format: canvasFormat })

const vertices = new Float32Array([0.0, 0.5, -0.5, -0.5, 0.5, -0.5])
const vertexBuffer = device.createBuffer({
  size: vertices.byteLength,
  usage: GPUBufferUsage.VERTEX | GPUBufferUsage.COPY_DST,
  mappedAtCreation: true
})
new Float32Array(vertexBuffer.getMappedRange()).set(vertices)
vertexBuffer.unmap()

const shaderModule = device.createShaderModule({ code: shaderCode })

const renderPipeline = device.createRenderPipeline({
  layout: "auto",
  vertex: {
    module: shaderModule,
    entryPoint: "vs_main",
    buffers: [
      {
        arrayStride: vertices.BYTES_PER_ELEMENT * 2,
        attributes: [
          {
            shaderLocation: 0,
            offset: 0,
            format: "float32x2"
          }
        ]
      }
    ]
  },
  fragment: {
    module: shaderModule,
    entryPoint: "fs_main",
    targets: [
      {
        format: canvasFormat
      }
    ]
  }
})

const commandEncoder = device.createCommandEncoder()

const renderPass = commandEncoder.beginRenderPass({
  colorAttachments: [
    {
      view: context.getCurrentTexture().createView(),
      loadOp: "clear",
      clearValue: { r: 0.32, g: 0.34, b: 0.36, a: 1 },
      storeOp: "store"
    }
  ]
})
renderPass.setPipeline(renderPipeline)
renderPass.setVertexBuffer(0, vertexBuffer)
renderPass.draw(3)
renderPass.end()

device.queue.submit([commandEncoder.finish()])
```

å®Ÿè¡Œçµæœã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

<DemoLinkWithResult
  url="https://tomixyz-sketchbook.pages.dev/basics/webgpu-triangle-vertex-buffer/"
  result={img_WebGPUTriangleVertexBuffer}
  title="é ‚ç‚¹ãƒãƒƒãƒ•ã‚¡ã‚’ä½¿ã£ã¦ä¸‰è§’å½¢ã‚’æç”»ã™ã‚‹ãƒ‡ãƒ¢"
/>
