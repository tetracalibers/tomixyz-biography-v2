---
title: 分割ファイル単体でも定理番号を正しく設定
date: "2025-08-25"
description: 子ファイルの単体コンパイルでも定理番号などを正しく設定・参照させるために
tags:
  - latex
  # - tcolorbox
series: latex-recipe
draft: true
---

[Imaging Math](https://tomixyz-latex-notes.pages.dev/)というサイトでは、LaTeXで制作した個人的な数学ノートを公開しています。

その中でも「線形代数の整理帳」は現時点で450ページを超えており、このような大規模な文書を1つの`.tex`ファイルで管理するのは危険です。（VS CodeのLaTeX Workshopを使っていますが、数万行を超えた時点でファイルの保存すらできなくなりました。）

そこで、[subfiles](https://ctan.org/pkg/subfiles)パッケージを利用して、章、節ごとにファイルを分割して管理しています。

`subfiles`を使うことで、プリアンブルを親ファイル側で一元管理しつつ、子ファイルを単体でコンパイルすることもできるようになります。
全文のPDFだけでなく、「章ごとのPDFファイルも生成したい」といったニーズにも簡単に応えてくれるパッケージですが、ファイル分割をしている以上、厄介になるのが章・定理などの番号（カウンタ）の設定と相互参照です。

この記事では、…

## ファイルを分割して階層ごとに管理する

次のディレクトリ構成は、「線形代数の整理帳」のディレクトリ構成を簡単に模したものです。

```tree title="原稿のディレクトリ構成"
.
├── contents
│   ├── chapter-1
│   │   └── section-1.tex
│   ├── chapter-1.tex
│   ├── chapter-2
│   │   └── section-1.tex
│   └── chapter-2.tex
└── master.tex
```

`全文(master) > 章(chapter) > 節(section)`という階層ごとに分けてファイルを管理しています。

`section-*.tex`は節（セクション）ごとに用意し、ここに本文を書きます。
執筆の際は`section-*.tex`を単体でコンパイルすることで、今書いている部分だけを素早く確認しながら作業を進めることができます。

セクションを束ねて1つのチャプターとするのが、`chapter-*.tex`です。
各`chapter-*.tex`をコンパイルすれば、章（チャプター）ごとのPDFファイルが生成されます。

さらに、すべてのチャプターを束ねて文書全体を完成させるのが`master.tex`です。
`master.tex`をコンパイルすれば、全文のPDFファイルが生成されます。

```tex title="master.tex（全文を束ねるファイル）" showLineNumbers {8-9,18-20}
\documentclass[dvipdfmx,14pt]{jsreport}

\title{線形代数の整理帳}
\author{tomixy}

% （他のパッケージやコマンド定義など）

% subfilesパッケージを読み込み
\usepackage{subfiles}

% ---

\begin{document}

\maketitle
\tableofcontents

% 分割した子ファイル（章）を読み込んで順番に配置
\subfile{contents/chapter-1}
\subfile{contents/chapter-2}

\end{document}
```

```tex title="contents/chapter-1.tex（節を束ねた章ごとのファイル）" showLineNumbers {1-2,8-9}
% master.texのプリアンブルを適用
\documentclass[../master]{subfiles}

\begin{document}

\chapter{ベクトル}

% 分割した子ファイル（節）を読み込んで順番に配置
\subfile{chapter-1/section-1}

\end{document}
```

```tex title="contents/chapter-1/section-1.tex（節ごとの本文ファイル）" showLineNumbers {1-2}
% master.texのプリアンブルを適用
\documentclass[../../master]{subfiles}

\begin{document}

\section{数ベクトル空間}

ここに本文を書く

\end{document}
```

```tree title="master.texのビルド後のディレクトリ構造"
.
├── .tex_intermediates
│   ├── master.aux
│   ├── master.fdb_latexmk
│   ├── master.fls
│   ├── master.log
│   └── master.toc
├── contents
│   ├── chapter-1
│   │   └── section-1.tex
│   ├── chapter-1.tex
│   ├── chapter-2
│   │   └── section-1.tex
│   └── chapter-2.tex
├── master.tex
└── out
    ├── contents
    │   └── chapter-1
    ├── master.dvi
    ├── master.pdf
    └── master.synctex.gz
```

## 子ファイルの単体コンパイルで起こる問題

このように`subfiles`を利用した構成では、各`chapter-*.tex`を単体でコンパイルすることで、章ごとのPDFファイルを生成することも簡単に叶います。

しかし、子ファイルの単体コンパイルで得られるPDFファイルの体裁をきちんと整えるのは意外と難しい問題です。分割した各ファイル単体のコンパイルでは、次のような問題が当たり前に発生するからです。

- 章番号が`1`から始まる
- 定理番号に章番号を含めている場合、その番号も`1`から始まる
- 別ファイルの定理などへの参照は、解決できずに`?`で表示されてしまう

たとえば、第2章`chapter-2.tex`を単体でコンパイルする場合、当然ながら`chapter-2.tex`に含まれている情報だけを読み込んでコンパイルが行われます。

`chapter-2.tex`はその前に別な章があることなど知らないので、第1章という扱いになります。
他の章、たとえば`chapter-1.tex`に書かれた内容は読み込まれないので、`chapter-1.tex`に書かれた定理を参照しようとしても、コンパイラはその定理番号やタイトルを知る術がないのです。

このような子ファイルの単体コンパイルは、あくまでも執筆を進める上でのデバッグ用途であり、最終成果物として全文PDFさえ整っていればよいという場合が多いかもしれません。

しかし、数百ページ規模の全文PDFは、特定の章だけを復習したい場合に適したものではありません。
章ごとのファイルでは、別な章の定理へのリンクは切れてしまうにしろ、せめて「第何章の定理なのか」は分かるように、単体コンパイルでも章番号や定理番号を適切に設定する仕組みが必要でした。

## 残課題：ファイルをまたぐリンク

これで、別ファイルの定理の番号も正しく表示されるようになりましたが、別ファイルの定理へのリンクをクリックしても、ファイルをまたいで移動することはできません。

[zref-xr](todo)というパッケージを使えば、ファイルをまたいだ移動ができるようになると小耳に挟みましたが、今回は各PDFファイルをWeb上に公開するということもあり、このパッケージは試していません。

しかし、リンクが機能するのかどうか、クリックするまでわからないというのは微妙なので、クリックしても移動できない別ファイルへのリンクだけ色を変える（本文と同じ色にする）みたいなことができたらいいな、と思っています…
