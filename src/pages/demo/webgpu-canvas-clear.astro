---
import WebGPUDemoLayout from "$/layouts/webgpu-demo.astro"
---

<WebGPUDemoLayout title="WebGPUによるキャンバスの塗りつぶし">
  <canvas id="canvas" width="640" height="480"></canvas>
</WebGPUDemoLayout>

<script>
  const adapter = await navigator.gpu.requestAdapter()
  if (!adapter) {
    throw new Error("WebGPU cannot be initialized - Adapter not found")
  }

  const device = await adapter.requestDevice()
  device.lost.then(() => {
    throw new Error("WebGPU cannot be initialized - Device has been lost")
  })

  const canvas = document.querySelector("canvas")
  const context = canvas!.getContext("webgpu")
  if (!context) {
    throw new Error("WebGPU cannot be initialized - Canvas does not support WebGPU")
  }

  const format = navigator.gpu.getPreferredCanvasFormat()
  context.configure({ device, format })

  const encoder = device.createCommandEncoder()
  const pass = encoder.beginRenderPass({
    colorAttachments: [
      {
        view: context.getCurrentTexture().createView(),
        loadOp: "clear",
        clearValue: { r: 0.5, g: 0.5, b: 0.5, a: 1 },
        storeOp: "store"
      }
    ]
  })

  pass.end()

  device.queue.submit([encoder.finish()])
</script>
