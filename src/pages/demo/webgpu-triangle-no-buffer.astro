---
import WebGPUDemoLayout from "$/layouts/webgpu-demo.astro"
---

<WebGPUDemoLayout title="WebGPUによる三角形（頂点バッファを使わずに）">
  <canvas id="canvas" width="640" height="480"></canvas>
</WebGPUDemoLayout>

<script>
  import shaderCode from "$/demo/webgpu-triangle-no-buffer/shader.wgsl?raw"

  const adapter = await navigator.gpu.requestAdapter()
  if (!adapter) {
    throw new Error("WebGPU cannot be initialized - Adapter not found")
  }

  const device = await adapter.requestDevice()
  device.lost.then(() => {
    throw new Error("WebGPU cannot be initialized - Device has been lost")
  })

  const canvas = document.querySelector("canvas")
  const context = canvas!.getContext("webgpu")
  if (!context) {
    throw new Error("WebGPU cannot be initialized - Canvas does not support WebGPU")
  }

  const format = navigator.gpu.getPreferredCanvasFormat()
  context.configure({ device, format })

  const shaderModule = device.createShaderModule({ code: shaderCode })

  const pipeline = device.createRenderPipeline({
    layout: "auto",
    vertex: {
      module: shaderModule,
      entryPoint: "vs_main"
    },
    fragment: {
      module: shaderModule,
      entryPoint: "fs_main",
      targets: [{ format }]
    }
  })

  const encoder = device.createCommandEncoder()
  const pass = encoder.beginRenderPass({
    colorAttachments: [
      {
        view: context.getCurrentTexture().createView(),
        loadOp: "clear",
        clearValue: { r: 0.32, g: 0.34, b: 0.36, a: 1 },
        storeOp: "store"
      }
    ]
  })

  pass.setPipeline(pipeline)
  pass.draw(3)
  pass.end()

  device.queue.submit([encoder.finish()])
</script>
