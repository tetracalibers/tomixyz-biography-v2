---
import { Image } from "astro:assets"

interface Props {
  src: ImageMetadata
  caption?: string
  alt?: string
  optimization?: boolean
  responsive?: {
    maxHeight: string
    bgColor: string
  }
}

const { src, alt = "", caption, optimization = true, responsive } = Astro.props
---

<figure class="FigureBox" class:list={[{ "-responsive": responsive }]}>
  {caption && <figcaption class="_caption">{caption}</figcaption>}
  {optimization ? <Image src={src} alt={alt} /> : <img src={src.src} alt={alt} />}
</figure>

<style define:vars={{ "r-max-height": responsive?.maxHeight, "r-bg-color": responsive?.bgColor }}>
  .FigureBox {
    --_title-border: #6e85b7;
    --_padding: clamp(0.2rem, 2.5vw, 0.75rem);

    width: 100%;
    margin: 0;
    padding: var(--_padding);
    background-color: rgba(203, 213, 225, 0.3);
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
  }
  :global(.dark) .FigureBox {
    --_title-border: #94b3fd;

    background-color: rgba(255, 255, 255, 0.3);
  }
  .FigureBox > ._caption {
    display: inline-flex;
    align-items: center;

    width: fit-content;

    margin-block-start: calc(var(--_padding) * -1);
    margin-inline-start: calc(var(--_padding) * -1 + -6px);
    margin-inline-end: calc(var(--_padding) * -1);

    padding-block: 0.3em;
    padding-inline: 0.7em;

    position: relative;
    top: 0;

    font-weight: bold;
    font-size: clamp(0.6rem, 2.9vw, 0.875rem);

    border-width: 1px;
    border-style: solid;
    border-color: var(--_title-border);

    border-top-left-radius: 0.5em;
    border-bottom-right-radius: 0.5em;

    color: var(--_title-border);
    background-color: #eef1ff;
  }

  :global(html.dark) ._caption {
    background: linear-gradient(90deg, rgb(49, 54, 90), rgba(15, 23, 42, 0.5));
    filter: saturate(1.5);
  }

  ._caption::before {
    position: absolute;
    top: calc(100% + 1px);
    left: -1px;
    content: "";
    border: 3px solid transparent;
    border-top: 3px solid var(--_title-border);
    border-right: 3px solid var(--_title-border);
  }

  .-responsive img {
    --space: clamp(0rem, -1.156rem + 4.931vw, 2rem);
    max-height: calc(var(--r-max-height) + var(--space) * 2);
    object-fit: contain;
    padding: var(--space);
    width: 100%;
    height: 100%;
    box-sizing: border-box;
    object-position: center;
    background-color: var(--r-bg-color);
  }
</style>
